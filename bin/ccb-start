#!/bin/bash
# CCB æ™ºèƒ½å¯åŠ¨è„šæœ¬ - åªæ¸…ç†çœŸæ­£çš„åƒµå°¸ sessions

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥åƒµå°¸ sessions...${NC}"

# 1. æ™ºèƒ½æ¸…ç†ï¼šåªæ¸…ç†ä¸»è¿›ç¨‹å·²æ­»çš„åƒµå°¸ sessions
ZOMBIE_SESSIONS=()
for session in $(tmux list-sessions 2>/dev/null | grep -E "codex-|gemini-" | cut -d: -f1); do
    # ä» session åç§°æå– PIDï¼ˆæ ¼å¼ï¼šcodex-<pid>-<random> æˆ– gemini-<pid>-<random>ï¼‰
    PID=$(echo "$session" | cut -d- -f2)
    
    # æ£€æŸ¥è¿™ä¸ª PID æ˜¯å¦è¿˜å­˜åœ¨
    if ! ps -p "$PID" > /dev/null 2>&1; then
        ZOMBIE_SESSIONS+=("$session")
    fi
done

if [ ${#ZOMBIE_SESSIONS[@]} -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  å‘ç° ${#ZOMBIE_SESSIONS[@]} ä¸ªçœŸæ­£çš„åƒµå°¸ sessionsï¼ˆä¸»è¿›ç¨‹å·²æ­»ï¼‰${NC}"
    for session in "${ZOMBIE_SESSIONS[@]}"; do
        echo "    - $session"
        tmux kill-session -t "$session" 2>/dev/null
    done
    echo -e "${GREEN}âœ… å·²æ¸…ç†åƒµå°¸ sessions${NC}"
else
    echo -e "${GREEN}âœ… æ²¡æœ‰åƒµå°¸ sessions${NC}"
fi

# 2. ä½¿ç”¨å½“å‰ç›®å½•
CURRENT_DIR=$(pwd)
echo -e "${GREEN}ğŸ“‚ å½“å‰ç›®å½•: $CURRENT_DIR${NC}"

# æ£€æŸ¥è¿™ä¸ªç›®å½•æ˜¯å¦å·²ç»æœ‰ CCB åœ¨è¿è¡Œ
PROJECT_HASH=$(echo -n "$CURRENT_DIR" | md5sum | cut -d' ' -f1 | head -c 16)
LOCK_FILE="$HOME/.cache/ccb/projects/$PROJECT_HASH/lock"

if [ -f "$LOCK_FILE" ]; then
    LOCK_PID=$(cat "$LOCK_FILE" 2>/dev/null)
    if ps -p "$LOCK_PID" > /dev/null 2>&1; then
        echo -e "${RED}âŒ CCB å·²ç»åœ¨è¿è¡Œ (PID: $LOCK_PID)${NC}"
        echo -e "${YELLOW}ğŸ’¡ å¦‚æœæƒ³è¿æ¥åˆ°ç°æœ‰å®ä¾‹ï¼Œè¯·åœ¨å¯¹åº”çš„ç»ˆç«¯æ“ä½œ${NC}"
        echo -e "${YELLOW}ğŸ’¡ å¦‚æœæƒ³å¯åŠ¨æ–°å®ä¾‹ï¼Œè¯·å…ˆåœæ­¢æ—§çš„æˆ–åˆ‡æ¢åˆ°ä¸åŒç›®å½•${NC}"
        exit 1
    else
        # é”æ–‡ä»¶å­˜åœ¨ä½†è¿›ç¨‹å·²æ­»ï¼Œæ¸…ç†é”æ–‡ä»¶
        echo -e "${YELLOW}âš ï¸  å‘ç°è¿‡æœŸçš„é”æ–‡ä»¶ï¼Œæ­£åœ¨æ¸…ç†...${NC}"
        rm -f "$LOCK_FILE"
        echo -e "${GREEN}âœ… å·²æ¸…ç†è¿‡æœŸé”æ–‡ä»¶${NC}"
    fi
fi

# 3. åŒæ­¥ tmux å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœå·²åœ¨ tmux ä¸­ï¼‰
if [ -n "$TMUX" ]; then
    echo -e "${YELLOW}ğŸ”„ åŒæ­¥ tmux ç¯å¢ƒå˜é‡...${NC}"
    # æ›´æ–° tmux å…¨å±€ç¯å¢ƒ
    tmux set-environment -g ANTHROPIC_API_KEY "${ANTHROPIC_API_KEY:-}"
    tmux set-environment -g ANTHROPIC_BASE_URL "${ANTHROPIC_BASE_URL:-}"
    tmux set-environment -g HTTP_PROXY "${HTTP_PROXY:-}"
    tmux set-environment -g HTTPS_PROXY "${HTTPS_PROXY:-}"
    # ä» tmux ç¯å¢ƒåŒæ­¥å›å½“å‰ shell
    eval $(tmux show-environment -s 2>/dev/null | grep -E "^(ANTHROPIC_|HTTP_PROXY|HTTPS_PROXY|ALL_PROXY)")
fi

# 4. æ£€æŸ¥æ˜¯å¦åœ¨ tmux ä¸­
if [ -z "$TMUX" ]; then
    echo -e "${YELLOW}ğŸªŸ æ£€æµ‹åˆ°ä¸åœ¨ tmux ä¸­ï¼Œæ­£åœ¨å¯åŠ¨ tmux...${NC}"
    echo
    # åœ¨æ–° tmux session ä¸­å¯åŠ¨ CCBï¼ˆæ˜¾å¼åˆå§‹åŒ– condaï¼‰
    CONDA_BASE="$HOME/anaconda3"
    if [ "$#" -gt 0 ]; then
        exec tmux new-session "cd '$CURRENT_DIR' && source '$CONDA_BASE/etc/profile.d/conda.sh' && conda activate ccb && ccb -a $* ; exec bash"
    else
        exec tmux new-session "cd '$CURRENT_DIR' && source '$CONDA_BASE/etc/profile.d/conda.sh' && conda activate ccb && ccb -a codex gemini claude ; exec bash"
    fi
else
    # å·²ç»åœ¨ tmux ä¸­ï¼Œç›´æ¥åœ¨å½“å‰çª—å£å¯åŠ¨ CCB

    # æ£€æŸ¥ conda ç¯å¢ƒ
    if [ -z "$CONDA_DEFAULT_ENV" ] || [ "$CONDA_DEFAULT_ENV" != "ccb" ]; then
        echo -e "${YELLOW}ğŸ æ¿€æ´» conda ccb ç¯å¢ƒ...${NC}"
        source ~/anaconda3/etc/profile.d/conda.sh
        conda activate ccb
    fi

    echo
    echo -e "${GREEN}ğŸš€ å¯åŠ¨ CCB...${NC}"

    # å¦‚æœä¼ å…¥äº†å‚æ•°ï¼Œä½¿ç”¨å‚æ•°ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„ codex gemini claude
    if [ "$#" -gt 0 ]; then
        echo -e "${YELLOW}å‘½ä»¤: ccb -a $@${NC}"
        echo
        ccb -a "$@"
    else
        echo -e "${YELLOW}å‘½ä»¤: ccb -a codex gemini claude${NC}"
        echo
        ccb -a codex gemini claude
    fi
fi
