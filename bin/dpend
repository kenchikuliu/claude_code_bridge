#!/usr/bin/env python3
"""
dpend - View latest Droid reply
"""

import json
import os
import sys
from pathlib import Path
import argparse

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding

setup_windows_encoding()

from cli_output import EXIT_ERROR, EXIT_NO_REPLY, EXIT_OK
from droid_comm import DroidLogReader, read_droid_session_start
from ccb_protocol import strip_trailing_markers
from askd_client import resolve_work_dir_with_registry
from providers import DASK_CLIENT_SPEC
from session_utils import find_project_session_file, safe_write_session
from project_id import compute_ccb_project_id
from pane_registry import load_registry_by_project_id


def _debug_enabled() -> bool:
    return (os.environ.get("CCB_DEBUG") in ("1", "true", "yes")) or (os.environ.get("DPEND_DEBUG") in ("1", "true", "yes"))


def _debug(message: str) -> None:
    if not _debug_enabled():
        return
    print(f"[DEBUG] {message}", file=sys.stderr)


def _load_session_path(work_dir: Path) -> Path | None:
    session_file = find_project_session_file(work_dir, ".droid-session")
    if not session_file:
        return None
    try:
        with session_file.open("r", encoding="utf-8-sig") as f:
            data = json.load(f)
        path_str = data.get("droid_session_path")
        if path_str:
            return Path(path_str).expanduser()
    except Exception as exc:
        _debug(f"Failed to read .droid-session ({session_file}): {exc}")
    return None


def _update_session_file(work_dir: Path, actual_session: Path) -> None:
    session_file = find_project_session_file(work_dir, ".droid-session")
    if not session_file:
        return
    try:
        with session_file.open("r", encoding="utf-8") as f:
            data = json.load(f)
        if not isinstance(data, dict):
            data = {}
    except Exception:
        data = {}

    actual_str = str(actual_session)
    updated = False
    if data.get("droid_session_path") != actual_str:
        data["droid_session_path"] = actual_str
        updated = True

    _cwd, session_id = read_droid_session_start(actual_session)
    if session_id and data.get("droid_session_id") != session_id:
        data["droid_session_id"] = session_id
        updated = True

    if not updated:
        return
    payload = json.dumps(data, ensure_ascii=False, indent=2) + "\n"
    safe_write_session(session_file, payload)


def main(argv: list[str]) -> int:
    try:
        parser = argparse.ArgumentParser(prog="dpend", add_help=True)
        parser.add_argument("n", nargs="?", type=int, default=1, help="Show the latest N conversations")
        parser.add_argument("--raw", action="store_true", help="Do not strip protocol/harness marker lines")
        parser.add_argument("--session-file", dest="session_file", default=None, help="Path to .droid-session (or .ccb_config/.droid-session)")
        args = parser.parse_args(argv[1:])

        n = max(1, int(args.n or 1))
        raw = bool(args.raw)

        work_dir, _explicit_session_file = resolve_work_dir_with_registry(
            DASK_CLIENT_SPEC,
            provider="droid",
            cli_session_file=args.session_file,
            env_session_file=os.environ.get("CCB_SESSION_FILE"),
        )

        registry_session_path: Path | None = None
        try:
            pid = compute_ccb_project_id(work_dir)
        except Exception:
            pid = ""
        if pid:
            rec = load_registry_by_project_id(pid, "droid")
            if rec:
                providers = rec.get("providers") if isinstance(rec.get("providers"), dict) else {}
                droid = providers.get("droid") if isinstance(providers, dict) else None
                path_str = (droid or {}).get("droid_session_path") if isinstance(droid, dict) else None
                if isinstance(path_str, str) and path_str.strip():
                    registry_session_path = Path(path_str.strip()).expanduser()

        session_path = _load_session_path(work_dir)
        if session_path:
            _debug(f"Using droid_session_path from .droid-session: {session_path}")
        elif registry_session_path and registry_session_path.exists():
            session_path = registry_session_path
            _debug(f"Using droid_session_path from registry: {session_path}")

        reader = DroidLogReader(work_dir=work_dir)
        if session_path and session_path.exists():
            reader.set_preferred_session(session_path)

        actual_session = reader.current_session_path()
        if actual_session:
            _update_session_file(work_dir, actual_session)

        if n > 1:
            conversations = reader.latest_conversations(n)
            if not conversations:
                print("No reply available", file=sys.stderr)
                return EXIT_NO_REPLY
            for i, (question, reply) in enumerate(conversations):
                if question:
                    print(f"Q: {question}")
                cleaned = reply if raw else strip_trailing_markers(reply or "")
                print(f"A: {cleaned}")
                if i < len(conversations) - 1:
                    print("---")
            return EXIT_OK

        message = reader.latest_message()
        if not message:
            print("No reply available", file=sys.stderr)
            return EXIT_NO_REPLY
        print(message if raw else strip_trailing_markers(message))
        return EXIT_OK
    except Exception as exc:
        if _debug_enabled():
            import traceback

            traceback.print_exc()
        print(f"[ERROR] execution failed: {exc}", file=sys.stderr)
        return EXIT_ERROR


if __name__ == "__main__":
    sys.exit(main(sys.argv))
